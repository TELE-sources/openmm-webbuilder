<!DOCTYPE html>
<html lang="en">
  <head>
    <title>OpenMM WebBuilder</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon"> 
    <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon"> 

    <!-- Bootstrap, jQuery -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
    <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

    <!-- underscore.js, backbone.js -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js"></script>
    
    
    <!-- Google Code Prettifier for syntax highlighting-->
    <script src="//cdnjs.cloudflare.com/ajax/libs/prettify/r224/prettify.js" type="text/javascript"></script>
    <link href="//cdnjs.cloudflare.com/ajax/libs/prettify/r224/prettify.css" type="text/css">
    <script src="//google-code-prettify.googlecode.com/svn/loader/run_prettify.js?autorun=false"></script>

    <!-- Mustache templates -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/mustache.js/0.7.2/mustache.min.js"></script>

   <!-- my stuff --> 
    <link href="templates/template.mustache" rel="template" id="template-mustache"/>
    <link href="css/style.css" rel="stylesheet">
    
    <!-- Backbone.Forms extension-->
    <!-- <script src="js/libs/backbone.forms/backbone-forms.js"></script>
    <script src="js/libs/backbone.forms/list.js"></script>
    <script src="js/libs/backbone.forms/backbone.bootstrap-modal.js"></script>  
    <script src="js/libs/backbone.forms/bootstrap.js"></script>
    <script src="js/libs/chevron.js"></script>
    <script src="js/libs/bootbox.min.js"></script>
    <script src="js/libs/base64.js"></script> -->
    
    <!-- minified versions of all of the libs above-->
    <script src="js/lib.min.js"></script>
    
    <!-- but keep this app stuff unmified, for easier development -->
    <script src="js/models.js"></script>
    <script src="js/views.js"></script>
    <script src="js/main.js"></script>
    
    
    <!-- Hacking save-to-gist -->
    <script type="text/javascript">$(function() {
	var load_token_from_dom = function() {
	    // get the access token from local storage or the DOM
	    // if the token hasn't been retreived yet, this'll return
	    // undefined.
	    if (Modernizr.localstorage) {
		var token = localStorage.getItem('github-access-token');
	    } else {
		var token = $('#save-script-gist').data('github-access-token');
	    }
	    return token;
	};

	var save_token_to_dom = function (access_token) {
	    // save the access token in local storage, if avaialable, or
	    // in the DOM. local storage is nice since it is persistent
	    // if the user refeshes
	    if (Modernizr.localstorage) {
		localStorage.setItem('github-access-token', access_token);
	    } else {
		$('#save-script-gist').data('github-access-token', access_token);
	    }
	};

	var load_gist_id = function () {
	    if (Modernizr.localstorage) {
		var id = localStorage.getItem('github-gist-id');
	    } else {
		var id = window['github-gist-id']; 
	    }
	    return id;
	}

	var save_gist_id = function(id) {
	    if (Modernizr.localstorage) {
		localStorage.setItem('github-gist-id', id);
	    } else {
		window['github-gist-id'] = id;
	    }
	}

	var send_gist = function () {
	    // get the filename
	    var filename = $('#save-form input[name="filename"]').val();
	    if (filename == '') {
		filename = $('#save-form input[name="filename"]').attr('placeholder');
	    }
	    // get the code from the DOM
	    var rawcode =  $('<div />').html($('#code').data('rawcode')).text();

	    if (load_gist_id() != undefined) {
		console.log('update');

		// if the gist has already been saved
		$.ajax(url, {
		    url: 'https://api.github.com/gists/' + load_gist_id() + 
			'?access_token=' + load_token_from_dom(),
		    type: 'PATCH',
		    data: JSON.stringify({
			files: {filename: {content: rawcode}}
		    }),
		    sucess: function (gist) {
			console.log('sucess');
			if $('#gist-link'.length == 0) {
			    var link = $('<li id="gist-link"><a target="_blank" href="' + 
					 gist.html_url +  '">Gist</a>');
			    $('.navbar ul.nav').append(link);
			}
		    }
		});

	    } else {
		var url = 'https://api.github.com/gists' +
		    '?access_token=' + load_token_from_dom();
		var data = JSON.stringify({
		    "public": true,
		    "files": {filename: {"content": rawcode}}
		});
	 	$.post(url, data, function (gist) {
		    // make a new link in the nav bar to the new gist
		    var link = $('<li id="gist-link"><a target="_blank" href="' + 
				 gist.html_url +  '">Gist</a>');
		    save_gist_id(gist.id);
		    $('.navbar ul.nav').append(link);
		});
	    }
	};

	// Step 4
	window.addEventListener('message', function (event) {
	    var code = event.data;
	    // Step 5
	    $.get('token?code=' + code, function (access_token) {
		// Step 7
		save_token_to_dom(access_token);
		send_gist();
	    });
	});
	
	$('#save-script-gist').click(function () {
	    if (load_token_from_dom() == undefined) {
		//Step 2
		window.open('https://github.com' + 
			    '/login/oauth/authorize' + 
			    '?client_id=a6a4c15c8e5250bea5c1' +
			    '&scope=gist');
		return;
	    }
	    send_gist();
	});
    });</script>

  </head>
  <body>

<a href="https://github.com/rmcgibbo/openmm-webbuilder"><img style="position: absolute; top: 0; right: 0; border: 0; z-index:999999" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>    


<!-- Navbar At Top of Page -->
<div class="navbar navbar-top">
  <div class="navbar-inner">
    <div class="container">
      <a class="brand" href="#">OpenMM-Builder</a>
      <div class="nav-collapse collapse">
        <ul class="nav">
          <!-- <li><a href='#'>Home</a></li> -->
          <li class="dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown">Get Help</a>
            <ul class="dropdown-menu">
              <li><a href="http://www.scribd.com/doc/133048853/Open-Mm-Users-Guide" target="_blank">OpenMM User Guide »</a></li>
              <li><a href="https://simtk.org/api_docs/openmm/api5_0/python/" target="_blank">OpenMM Python API Docs »</a></li>
            </ul>
          <li class="divider-vertical"></li>
          <li>
            <form id="save-form" method="post" action="/save" class="navbar-form">
              <input name="filename" placeholder="openmm.py" type="text" style="width:100px">
              <button type="button" id="save-script-local" class="btn">Save Script</button>
            </form>
          </li>
          <li><button type="button" id="save-script-gist" class="btn">Save to Gist</button></li>
        </ul>
      </div><!--/.nav-collapse -->      
    </div>
  </div>
</div>
<!--  End NavBar-->

<!-- Two column layout -->
<div class="container-fluid">
  <div class="row-fluid">
    <div class="span4">
      <ul id="sidebar-tab" class="nav nav-pills nav-tabs">
        <li class="active"><a href="#general">General</a></li>
        <li><a href="#system">System</a></li>
        <li><a href="#integrator">Integrator</a></li>
        <li><a href='#simulation'>Simulation</a></li>
      </ul>
      <!--Sidebar content-->
      <div class="tab-content">
        <div class="tab-pane fade in active" id="general"><div id="sidepane-general"></div></div>
        <div class="tab-pane fade in" id="system"><div id="sidepane-system"></div></div>
        <div class="tab-pane fade in" id="integrator"><div id="sidepane-integrator"></div></div>
        <div class="tab-pane fade in" id="simulation"><div id="sidepane-simulation"></div></div>
      </div>
      
    </div>
    <div class="span7">
      <!--Body content-->
      <pre id="code"></pre>
    </div>
  </div>

</div>

<div class="wrap">
  <div id="footer">
    <div class="span2"></div>
    <div class="span8"><p class="muted credit">
      Courtesy of <a href="http://stanford.edu/~rmcgibbo/">Robert McGibbon</a>,
      code on <a href="https://github.com/rmcgibbo/openmm-webbuilder">github</a>.
    </p></div>
  </div>
</div>

</body>
</html>


