(function(root){if(typeof exports!=="undefined"&&typeof require!=="undefined"){var $=root.jQuery||root.Zepto||root.ender||require("jquery"),_=root._||require("underscore"),Backbone=root.Backbone||require("backbone")}else{var $=root.jQuery,_=root._,Backbone=root.Backbone}var Form=function(){return Backbone.View.extend({hasFocus:false,initialize:function(options){if(!Form.templates.form)throw new Error("Templates not loaded");this.schema=function(){if(options.schema)return options.schema;var model=options.model;if(!model)throw new Error("Could not find schema");if(_.isFunction(model.schema))return model.schema();return model.schema}();options=_.extend({template:"form",fieldsetTemplate:"fieldset",fieldTemplate:"field"},options);if(!options.fieldsets){var fields=options.fields||_.keys(this.schema);options.fieldsets=[{fields:fields}]}this.options=options;this.model=options.model;this.data=options.data;this.fields={}},render:function(){var self=this,options=this.options,template=Form.templates[options.template];var $form=Form.helpers.parseHTML(template({fieldsets:'<b class="bbf-tmp"></b>'}));var $fieldsetContainer=$(".bbf-tmp",$form);_.each(options.fieldsets,function(fieldset){$fieldsetContainer.append(self.renderFieldset(fieldset))});$fieldsetContainer.children().unwrap();this.setElement($form);if(this.hasFocus)this.trigger("blur",this);return this},renderFieldset:function(fieldset){var self=this,template=Form.templates[this.options.fieldsetTemplate],schema=this.schema,getNested=Form.helpers.getNested;if(_.isArray(fieldset)){fieldset={fields:fieldset}}var $fieldset=Form.helpers.parseHTML(template(_.extend({},fieldset,{legend:'<b class="bbf-tmp-legend"></b>',fields:'<b class="bbf-tmp-fields"></b>'})));if(fieldset.legend){$fieldset.find(".bbf-tmp-legend").replaceWith(fieldset.legend)}else{$fieldset.find(".bbf-tmp-legend").parent().remove()}var $fieldsContainer=$(".bbf-tmp-fields",$fieldset);_.each(fieldset.fields,function(key){var itemSchema=function(){if(schema[key])return schema[key];var path=key.replace(/\./g,".subSchema.");return getNested(schema,path)}();if(!itemSchema)throw"Field '"+key+"' not found in schema";var field=self.fields[key]=self.createField(key,itemSchema);var fieldEl=field.render().el;field.editor.on("all",function(event){var args=_.toArray(arguments);args[0]=key+":"+event;args.splice(1,0,this);this.trigger.apply(this,args)},self);field.editor.on("change",function(){this.trigger("change",self)},self);field.editor.on("focus",function(){if(this.hasFocus)return;this.trigger("focus",this)},self);field.editor.on("blur",function(){if(!this.hasFocus)return;var self=this;setTimeout(function(){if(_.find(self.fields,function(field){return field.editor.hasFocus}))return;self.trigger("blur",self)},0)},self);if(itemSchema.type!=="Hidden"){$fieldsContainer.append(fieldEl)}});$fieldsContainer=$fieldsContainer.children().unwrap();return $fieldset},createField:function(key,schema){schema.template=schema.template||this.options.fieldTemplate;var options={form:this,key:key,schema:schema,idPrefix:this.options.idPrefix,template:this.options.fieldTemplate};if(this.model){options.model=this.model}else if(this.data){options.value=this.data[key]}else{options.value=null}return new Form.Field(options)},validate:function(){var self=this,fields=this.fields,model=this.model,errors={};_.each(fields,function(field){var error=field.validate();if(error){errors[field.key]=error}});if(model&&model.validate){var modelErrors=model.validate(this.getValue());if(modelErrors){var isDictionary=_.isObject(modelErrors)&&!_.isArray(modelErrors);if(!isDictionary){errors._others=errors._others||[];errors._others.push(modelErrors)}if(isDictionary){_.each(modelErrors,function(val,key){if(self.fields[key]&&!errors[key]){self.fields[key].setError(val);errors[key]=val}else{errors._others=errors._others||[];var tmpErr={};tmpErr[key]=val;errors._others.push(tmpErr)}})}}}return _.isEmpty(errors)?null:errors},commit:function(options){var errors=this.validate();if(errors)return errors;var modelError;var setOptions=_.extend({error:function(model,e){modelError=e}},options);this.model.set(this.getValue(),setOptions);if(modelError)return modelError},getValue:function(key){if(key)return this.fields[key].getValue();var values={};_.each(this.fields,function(field){values[field.key]=field.getValue()});return values},setValue:function(prop,val){var data={};if(typeof prop==="string"){data[prop]=val}else{data=prop}var key;for(key in this.schema){if(data[key]!==undefined){this.fields[key].setValue(data[key])}}},focus:function(){if(this.hasFocus)return;var fieldset=this.options.fieldsets[0];if(fieldset){var field;if(_.isArray(fieldset)){field=fieldset[0]}else{field=fieldset.fields[0]}if(field){this.fields[field].editor.focus()}}},blur:function(){if(!this.hasFocus)return;var focusedField=_.find(this.fields,function(field){return field.editor.hasFocus});if(focusedField)focusedField.editor.blur()},remove:function(){var fields=this.fields;for(var key in fields){fields[key].remove()}Backbone.View.prototype.remove.call(this)},trigger:function(event){if(event==="focus"){this.hasFocus=true}else if(event==="blur"){this.hasFocus=false}return Backbone.View.prototype.trigger.apply(this,arguments)}})}();Form.helpers=function(){var helpers={};helpers.getNested=function(obj,path){var fields=path.split(".");var result=obj;for(var i=0,n=fields.length;i<n;i++){result=result[fields[i]]}return result};helpers.keyToTitle=function(str){str=str.replace(/([A-Z])/g," $1");str=str.replace(/^./,function(str){return str.toUpperCase()});return str};helpers.compileTemplate=function(str){var _interpolateBackup=_.templateSettings.interpolate;_.templateSettings.interpolate=/\{\{(.+?)\}\}/g;var template=_.template(str);_.templateSettings.interpolate=_interpolateBackup;return template};helpers.createTemplate=function(str,context){var template=helpers.compileTemplate($.trim(str));if(!context){return template}else{return template(context)}};helpers.setTemplateCompiler=function(compiler){helpers.compileTemplate=compiler};helpers.setTemplates=function(templates,classNames){var createTemplate=helpers.createTemplate;Form.templates=Form.templates||{};Form.classNames=Form.classNames||{};_.each(templates,function(template,key,index){if(_.isString(template))template=createTemplate(template);Form.templates[key]=template});_.extend(Form.classNames,classNames)};helpers.createEditor=function(schemaType,options){var constructorFn;if(_.isString(schemaType)){constructorFn=Form.editors[schemaType]}else{constructorFn=schemaType}return new constructorFn(options)};helpers.getValidator=function(validator){var validators=Form.validators;if(_.isRegExp(validator)){return validators.regexp({regexp:validator})}if(_.isString(validator)){if(!validators[validator])throw new Error('Validator "'+validator+'" not found');return validators[validator]()}if(_.isFunction(validator))return validator;if(_.isObject(validator)&&validator.type){var config=validator;return validators[config.type](config)}throw new Error("Invalid validator: "+validator)};helpers.parseHTML=function(html){if($.parseHTML!==undefined){return $($.parseHTML(html))}return $(html)};return helpers}();Form.validators=function(){var validators={};validators.errMessages={required:"Required",regexp:"Invalid",email:"Invalid email address",url:"Invalid URL",match:'Must match field "{{field}}"'};validators.required=function(options){options=_.extend({type:"required",message:this.errMessages.required},options);return function required(value){options.value=value;var err={type:options.type,message:Form.helpers.createTemplate(options.message,options)};if(value===null||value===undefined||value===false||value==="")return err}};validators.regexp=function(options){if(!options.regexp)throw new Error('Missing required "regexp" option for "regexp" validator');options=_.extend({type:"regexp",message:this.errMessages.regexp},options);return function regexp(value){options.value=value;var err={type:options.type,message:Form.helpers.createTemplate(options.message,options)};if(value===null||value===undefined||value==="")return;if(!options.regexp.test(value))return err}};validators.email=function(options){options=_.extend({type:"email",message:this.errMessages.email,regexp:/^[\w\-]{1,}([\w\-\+.]{1,1}[\w\-]{1,}){0,}[@][\w\-]{1,}([.]([\w\-]{1,})){1,3}$/},options);return validators.regexp(options)};validators.url=function(options){options=_.extend({type:"url",message:this.errMessages.url,regexp:/^(http|https):\/\/(([A-Z0-9][A-Z0-9_\-]*)(\.[A-Z0-9][A-Z0-9_\-]*)+)(:(\d+))?\/?/i},options);return validators.regexp(options)};validators.match=function(options){if(!options.field)throw new Error('Missing required "field" options for "match" validator');options=_.extend({type:"match",message:this.errMessages.match},options);return function match(value,attrs){options.value=value;var err={type:options.type,message:Form.helpers.createTemplate(options.message,options)};if(value===null||value===undefined||value==="")return;if(value!==attrs[options.field])return err}};return validators}();Form.Field=function(){var helpers=Form.helpers,templates=Form.templates;return Backbone.View.extend({initialize:function(options){options=options||{};this.form=options.form;this.key=options.key;this.value=options.value;this.model=options.model;if(_.isString(options.schema))options.schema={type:options.schema};this.schema=_.extend({type:"Text",title:helpers.keyToTitle(this.key),template:"field"},options.schema)},renderingContext:function(schema,editor){return{key:this.key,title:schema.title,id:editor.id,type:schema.type,editor:'<b class="bbf-tmp-editor"></b>',help:'<b class="bbf-tmp-help"></b>',error:'<b class="bbf-tmp-error"></b>'}},render:function(){var schema=this.schema,templates=Form.templates;var options={form:this.form,key:this.key,schema:schema,idPrefix:this.options.idPrefix,id:this.getId()};if(this.model){options.model=this.model}else{options.value=this.value}var editor=this.editor=helpers.createEditor(schema.type,options);var $field=Form.helpers.parseHTML(templates[schema.template](this.renderingContext(schema,editor)));if(schema.title===false){$field.find('label[for="'+editor.id+'"]').first().remove()}$field.find(".bbf-tmp-editor").replaceWith(editor.render().el);this.$help=$(".bbf-tmp-help",$field).parent();this.$help.empty();if(this.schema.help)this.$help.html(this.schema.help);this.$error=$($(".bbf-tmp-error",$field).parent()[0]);if(this.$error)this.$error.empty();if(this.schema.fieldClass)$field.addClass(this.schema.fieldClass);if(this.schema.fieldAttrs)$field.attr(this.schema.fieldAttrs);this.setElement($field);return this},getId:function(){var prefix=this.options.idPrefix,id=this.key;id=id.replace(/\./g,"_");if(_.isString(prefix)||_.isNumber(prefix))return prefix+id;if(_.isNull(prefix))return id;if(this.model)return this.model.cid+"_"+id;return id},validate:function(){var error=this.editor.validate();if(error){this.setError(error.message)}else{this.clearError()}return error},setError:function(msg){if(this.editor.hasNestedForm)return;var errClass=Form.classNames.error;this.$el.addClass(errClass);if(this.$error){this.$error.html(msg)}else if(this.$help){this.$help.html(msg)}},clearError:function(){var errClass=Form.classNames.error;this.$el.removeClass(errClass);if(this.$error){this.$error.empty()}else if(this.$help){this.$help.empty();var helpMsg=this.schema.help;if(helpMsg)this.$help.html(helpMsg)}},commit:function(){return this.editor.commit()},getValue:function(){return this.editor.getValue()},setValue:function(value){this.editor.setValue(value)},focus:function(){this.editor.focus()},blur:function(){this.editor.blur()},remove:function(){this.editor.remove();Backbone.View.prototype.remove.call(this)}})}();Form.editors=function(){var helpers=Form.helpers;var editors={};editors.Base=Backbone.View.extend({defaultValue:null,hasFocus:false,initialize:function(options){var options=options||{};if(options.model){if(!options.key)throw"Missing option: 'key'";this.model=options.model;this.value=this.model.get(options.key)}else if(options.value){this.value=options.value}if(this.value===undefined)this.value=this.defaultValue;this.key=options.key;this.form=options.form;this.schema=options.schema||{};this.validators=options.validators||this.schema.validators;this.$el.attr("name",this.getName());if(this.schema.editorClass)this.$el.addClass(this.schema.editorClass);if(this.schema.editorAttrs)this.$el.attr(this.schema.editorAttrs)},getValue:function(){throw"Not implemented. Extend and override this method."},setValue:function(){throw"Not implemented. Extend and override this method."},focus:function(){throw"Not implemented. Extend and override this method."},blur:function(){throw"Not implemented. Extend and override this method."},getName:function(){var key=this.key||"";return key.replace(/\./g,"_")},commit:function(options){var error=this.validate();if(error)return error;this.listenTo(this.model,"invalid",function(model,e){error=e});this.model.set(this.key,this.getValue(),options);if(error)return error},validate:function(){var $el=this.$el,error=null,value=this.getValue(),formValues=this.form?this.form.getValue():{},validators=this.validators,getValidator=Form.helpers.getValidator;if(validators){_.every(validators,function(validator){error=getValidator(validator)(value,formValues);return error?false:true})}return error},trigger:function(event){if(event==="focus"){this.hasFocus=true}else if(event==="blur"){this.hasFocus=false}return Backbone.View.prototype.trigger.apply(this,arguments)}});editors.Text=editors.Base.extend({tagName:"input",defaultValue:"",previousValue:"",events:{keyup:"determineChange",keypress:function(event){var self=this;setTimeout(function(){self.determineChange()},0)},select:function(event){this.trigger("select",this)},focus:function(event){this.trigger("focus",this)},blur:function(event){this.trigger("blur",this)}},initialize:function(options){editors.Base.prototype.initialize.call(this,options);var schema=this.schema;var type="text";if(schema&&schema.editorAttrs&&schema.editorAttrs.type)type=schema.editorAttrs.type;if(schema&&schema.dataType)type=schema.dataType;this.$el.attr("type",type)},render:function(){this.setValue(this.value);return this},determineChange:function(event){var currentValue=this.$el.val();var changed=currentValue!==this.previousValue;if(changed){this.previousValue=currentValue;this.trigger("change",this)}},getValue:function(){return this.$el.val()},setValue:function(value){this.$el.val(value)},focus:function(){if(this.hasFocus)return;this.$el.focus()},blur:function(){if(!this.hasFocus)return;this.$el.blur()},select:function(){this.$el.select()}});editors.Number=editors.Text.extend({defaultValue:0,events:_.extend({},editors.Text.prototype.events,{keypress:"onKeyPress"}),initialize:function(options){editors.Text.prototype.initialize.call(this,options);this.$el.attr("type","number");this.$el.attr("step","any")},onKeyPress:function(event){var self=this,delayedDetermineChange=function(){setTimeout(function(){self.determineChange()},0)};if(event.charCode===0){delayedDetermineChange();return}var newVal=this.$el.val()+String.fromCharCode(event.charCode);var numeric=/^[0-9]*\.?[0-9]*?$/.test(newVal);if(numeric){delayedDetermineChange()}else{event.preventDefault()}},getValue:function(){var value=this.$el.val();return value===""?null:parseFloat(value,10)},setValue:function(value){value=function(){if(_.isNumber(value))return value;if(_.isString(value)&&value!=="")return parseFloat(value,10);return null}();if(_.isNaN(value))value=null;editors.Text.prototype.setValue.call(this,value)}});editors.Password=editors.Text.extend({initialize:function(options){editors.Text.prototype.initialize.call(this,options);this.$el.attr("type","password")}});editors.TextArea=editors.Text.extend({tagName:"textarea"});editors.Checkbox=editors.Base.extend({defaultValue:false,tagName:"input",events:{click:function(event){this.trigger("change",this)},focus:function(event){this.trigger("focus",this)},blur:function(event){this.trigger("blur",this)}},initialize:function(options){editors.Base.prototype.initialize.call(this,options);this.$el.attr("type","checkbox")},render:function(){this.setValue(this.value);return this},getValue:function(){return this.$el.prop("checked")},setValue:function(value){if(value){this.$el.prop("checked",true)}},focus:function(){if(this.hasFocus)return;this.$el.focus()},blur:function(){if(!this.hasFocus)return;this.$el.blur()}});editors.Hidden=editors.Base.extend({defaultValue:"",initialize:function(options){editors.Text.prototype.initialize.call(this,options);this.$el.attr("type","hidden")},getValue:function(){return this.value},setValue:function(value){this.value=value},focus:function(){},blur:function(){}});editors.Select=editors.Base.extend({tagName:"select",events:{change:function(event){this.trigger("change",this)},focus:function(event){this.trigger("focus",this)},blur:function(event){this.trigger("blur",this)}},initialize:function(options){editors.Base.prototype.initialize.call(this,options);if(!this.schema||!this.schema.options)throw"Missing required 'schema.options'"},render:function(){this.setOptions(this.schema.options);return this},setOptions:function(options){var self=this;if(options instanceof Backbone.Collection){var collection=options;if(collection.length>0){this.renderOptions(options)}else{collection.fetch({success:function(collection){self.renderOptions(options)}})}}else if(_.isFunction(options)){options(function(result){self.renderOptions(result)},self)}else{this.renderOptions(options)}},renderOptions:function(options){var $select=this.$el,html;html=this._getOptionsHtml(options);$select.html(html);this.setValue(this.value)},_getOptionsHtml:function(options){var html;if(_.isString(options)){html=options}else if(_.isArray(options)){html=this._arrayToHtml(options)}else if(options instanceof Backbone.Collection){html=this._collectionToHtml(options)}else if(_.isFunction(options)){var newOptions;options(function(opts){newOptions=opts},this);html=this._getOptionsHtml(newOptions)}return html},getValue:function(){return this.$el.val()},setValue:function(value){this.$el.val(value)},focus:function(){if(this.hasFocus)return;this.$el.focus()},blur:function(){if(!this.hasFocus)return;this.$el.blur()},_collectionToHtml:function(collection){var array=[];collection.each(function(model){array.push({val:model.id,label:model.toString()})});var html=this._arrayToHtml(array);return html},_arrayToHtml:function(array){var html=[];_.each(array,function(option){if(_.isObject(option)){if(option.group){html.push('<optgroup label="'+option.group+'">');html.push(this._getOptionsHtml(option.options));html.push("</optgroup>")}else{var val=option.val||option.val===0?option.val:"";html.push('<option value="'+val+'">'+option.label+"</option>")}}else{html.push("<option>"+option+"</option>")}},this);return html.join("")}});editors.Radio=editors.Select.extend({tagName:"ul",className:"bbf-radio",events:{"change input[type=radio]":function(){this.trigger("change",this)},"focus input[type=radio]":function(){if(this.hasFocus)return;this.trigger("focus",this)},"blur input[type=radio]":function(){if(!this.hasFocus)return;var self=this;setTimeout(function(){if(self.$("input[type=radio]:focus")[0])return;self.trigger("blur",self)},0)}},getValue:function(){return this.$("input[type=radio]:checked").val()},setValue:function(value){this.$("input[type=radio]").val([value])},focus:function(){if(this.hasFocus)return;var checked=this.$("input[type=radio]:checked");if(checked[0]){checked.focus();return}this.$("input[type=radio]").first().focus()},blur:function(){if(!this.hasFocus)return;this.$("input[type=radio]:focus").blur()},_arrayToHtml:function(array){var html=[];var self=this;_.each(array,function(option,index){var itemHtml="<li>";if(_.isObject(option)){var val=option.val||option.val===0?option.val:"";itemHtml+='<input type="radio" name="'+self.id+'" value="'+val+'" id="'+self.id+"-"+index+'" />';itemHtml+='<label for="'+self.id+"-"+index+'">'+option.label+"</label>"}else{itemHtml+='<input type="radio" name="'+self.id+'" value="'+option+'" id="'+self.id+"-"+index+'" />';itemHtml+='<label for="'+self.id+"-"+index+'">'+option+"</label>"}itemHtml+="</li>";html.push(itemHtml)});return html.join("")}});editors.Checkboxes=editors.Select.extend({tagName:"ul",className:"bbf-checkboxes",events:{"click input[type=checkbox]":function(){this.trigger("change",this)},"focus input[type=checkbox]":function(){if(this.hasFocus)return;this.trigger("focus",this)},"blur input[type=checkbox]":function(){if(!this.hasFocus)return;var self=this;setTimeout(function(){if(self.$("input[type=checkbox]:focus")[0])return;self.trigger("blur",self)},0)}},getValue:function(){var values=[];this.$("input[type=checkbox]:checked").each(function(){values.push($(this).val())});return values},setValue:function(values){if(!_.isArray(values))values=[values];this.$("input[type=checkbox]").val(values)},focus:function(){if(this.hasFocus)return;this.$("input[type=checkbox]").first().focus()},blur:function(){if(!this.hasFocus)return;this.$("input[type=checkbox]:focus").blur()},_arrayToHtml:function(array){var html=[];var self=this;_.each(array,function(option,index){var itemHtml="<li>";if(_.isObject(option)){var val=option.val||option.val===0?option.val:"";itemHtml+='<input type="checkbox" name="'+self.id+'" value="'+val+'" id="'+self.id+"-"+index+'" />';itemHtml+='<label for="'+self.id+"-"+index+'">'+option.label+"</label>"}else{itemHtml+='<input type="checkbox" name="'+self.id+'" value="'+option+'" id="'+self.id+"-"+index+'" />';itemHtml+='<label for="'+self.id+"-"+index+'">'+option+"</label>"}itemHtml+="</li>";html.push(itemHtml)});return html.join("")}});editors.Object=editors.Base.extend({hasNestedForm:true,className:"bbf-object",initialize:function(options){this.value={};editors.Base.prototype.initialize.call(this,options);if(!this.schema.subSchema)throw new Error("Missing required 'schema.subSchema' option for Object editor")},render:function(){this.form=new Form({schema:this.schema.subSchema,data:this.value,idPrefix:this.id+"_",fieldTemplate:"nestedField"});this._observeFormEvents();this.$el.html(this.form.render().el);if(this.hasFocus)this.trigger("blur",this);return this},getValue:function(){if(this.form)return this.form.getValue();return this.value},setValue:function(value){this.value=value;this.render()},focus:function(){if(this.hasFocus)return;this.form.focus()},blur:function(){if(!this.hasFocus)return;this.form.blur()},remove:function(){this.form.remove();Backbone.View.prototype.remove.call(this)},validate:function(){return this.form.validate()},_observeFormEvents:function(){this.form.on("all",function(){var args=_.toArray(arguments);args[1]=this;this.trigger.apply(this,args)},this)}});editors.NestedModel=editors.Object.extend({initialize:function(options){editors.Base.prototype.initialize.call(this,options);if(!options.schema.model)throw'Missing required "schema.model" option for NestedModel editor'},render:function(){var data=this.value||{},key=this.key,nestedModel=this.schema.model;var modelInstance=data.constructor===nestedModel?data:new nestedModel(data);this.form=new Form({model:modelInstance,idPrefix:this.id+"_",fieldTemplate:"nestedField"});this._observeFormEvents();this.$el.html(this.form.render().el);if(this.hasFocus)this.trigger("blur",this);return this},commit:function(){var error=this.form.commit();if(error){this.$el.addClass("error");return error}return editors.Object.prototype.commit.call(this)}});editors.Date=editors.Base.extend({events:{"change select":function(){this.updateHidden();this.trigger("change",this)},"focus select":function(){if(this.hasFocus)return;this.trigger("focus",this)},"blur select":function(){if(!this.hasFocus)return;var self=this;setTimeout(function(){if(self.$("select:focus")[0])return;self.trigger("blur",self)},0)}},initialize:function(options){options=options||{};editors.Base.prototype.initialize.call(this,options);var Self=editors.Date,today=new Date;this.options=_.extend({monthNames:Self.monthNames,showMonthNames:Self.showMonthNames},options);this.schema=_.extend({yearStart:today.getFullYear()-100,yearEnd:today.getFullYear()},options.schema||{});if(this.value&&!_.isDate(this.value)){this.value=new Date(this.value)}if(!this.value){var date=new Date;date.setSeconds(0);date.setMilliseconds(0);this.value=date}},render:function(){var options=this.options,schema=this.schema;var datesOptions=_.map(_.range(1,32),function(date){return'<option value="'+date+'">'+date+"</option>"});var monthsOptions=_.map(_.range(0,12),function(month){var value=options.showMonthNames?options.monthNames[month]:month+1;return'<option value="'+month+'">'+value+"</option>"});var yearRange=schema.yearStart<schema.yearEnd?_.range(schema.yearStart,schema.yearEnd+1):_.range(schema.yearStart,schema.yearEnd-1,-1);var yearsOptions=_.map(yearRange,function(year){return'<option value="'+year+'">'+year+"</option>"});var $el=Form.helpers.parseHTML(Form.templates.date({dates:datesOptions.join(""),months:monthsOptions.join(""),years:yearsOptions.join("")}));this.$date=$el.find('select[data-type="date"]');this.$month=$el.find('select[data-type="month"]');this.$year=$el.find('select[data-type="year"]');this.$hidden=$('<input type="hidden" name="'+this.key+'" />');$el.append(this.$hidden);this.setValue(this.value);this.setElement($el);this.$el.attr("id",this.id);if(this.hasFocus)this.trigger("blur",this);return this},getValue:function(){var year=this.$year.val(),month=this.$month.val(),date=this.$date.val();if(!year||!month||!date)return null;return new Date(year,month,date)},setValue:function(date){this.$date.val(date.getDate());this.$month.val(date.getMonth());this.$year.val(date.getFullYear());this.updateHidden()},focus:function(){if(this.hasFocus)return;this.$("select").first().focus()},blur:function(){if(!this.hasFocus)return;this.$("select:focus").blur()},updateHidden:function(){var val=this.getValue();if(_.isDate(val))val=val.toISOString();this.$hidden.val(val)}},{showMonthNames:true,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"]});editors.DateTime=editors.Base.extend({events:{"change select":function(){this.updateHidden();this.trigger("change",this)},"focus select":function(){if(this.hasFocus)return;this.trigger("focus",this)},"blur select":function(){if(!this.hasFocus)return;var self=this;setTimeout(function(){if(self.$("select:focus")[0])return;self.trigger("blur",self)},0)}},initialize:function(options){options=options||{};editors.Base.prototype.initialize.call(this,options);this.options=_.extend({DateEditor:editors.DateTime.DateEditor},options);this.schema=_.extend({minsInterval:15},options.schema||{});this.dateEditor=new this.options.DateEditor(options);this.value=this.dateEditor.value},render:function(){function pad(n){return n<10?"0"+n:n}var schema=this.schema;var hoursOptions=_.map(_.range(0,24),function(hour){return'<option value="'+hour+'">'+pad(hour)+"</option>"});var minsOptions=_.map(_.range(0,60,schema.minsInterval),function(min){return'<option value="'+min+'">'+pad(min)+"</option>"});var $el=Form.helpers.parseHTML(Form.templates.dateTime({date:'<b class="bbf-tmp"></b>',hours:hoursOptions.join(),mins:minsOptions.join()}));$el.find(".bbf-tmp").replaceWith(this.dateEditor.render().el);this.$hour=$el.find('select[data-type="hour"]');this.$min=$el.find('select[data-type="min"]');this.$hidden=$el.find('input[type="hidden"]');this.setValue(this.value);this.setElement($el);this.$el.attr("id",this.id);if(this.hasFocus)this.trigger("blur",this);return this},getValue:function(){var date=this.dateEditor.getValue();var hour=this.$hour.val(),min=this.$min.val();if(!date||!hour||!min)return null;date.setHours(hour);date.setMinutes(min);return date},setValue:function(date){if(!_.isDate(date))date=new Date(date);this.dateEditor.setValue(date);this.$hour.val(date.getHours());this.$min.val(date.getMinutes());this.updateHidden()},focus:function(){if(this.hasFocus)return;this.$("select").first().focus()},blur:function(){if(!this.hasFocus)return;this.$("select:focus").blur()},updateHidden:function(){var val=this.getValue();if(_.isDate(val))val=val.toISOString();this.$hidden.val(val)},remove:function(){this.dateEditor.remove();editors.Base.prototype.remove.call(this)}},{DateEditor:editors.Date});return editors}();Form.setTemplates=Form.helpers.setTemplates;Form.setTemplateCompiler=Form.helpers.setTemplateCompiler;Form.templates={};Form.setTemplates({form:'      <form class="bbf-form">{{fieldsets}}</form>    ',fieldset:"      <fieldset>        <legend>{{legend}}</legend>        <ul>{{fields}}</ul>      </fieldset>    ",field:'      <li class="bbf-field field-{{key}}">        <label for="{{id}}">{{title}}</label>        <div class="bbf-editor">{{editor}}</div>        <div class="bbf-help">{{help}}</div>        <div class="bbf-error">{{error}}</div>      </li>    ',nestedField:'      <li class="bbf-field bbf-nested-field field-{{key}}" title="{{title}}">        <label for="{{id}}">{{title}}</label>        <div class="bbf-editor">{{editor}}</div>        <div class="bbf-help">{{help}}</div>        <div class="bbf-error">{{error}}</div>      </li>    ',list:'      <div class="bbf-list">        <ul>{{items}}</ul>        <div class="bbf-actions"><button type="button" data-action="add">Add</div>      </div>    ',listItem:'      <li>        <button type="button" data-action="remove" class="bbf-remove">&times;</button>        <div class="bbf-editor-container">{{editor}}</div>      </li>    ',date:'      <div class="bbf-date">        <select data-type="date" class="bbf-date">{{dates}}</select>        <select data-type="month" class="bbf-month">{{months}}</select>        <select data-type="year" class="bbf-year">{{years}}</select>      </div>    ',dateTime:'      <div class="bbf-datetime">        <div class="bbf-date-container">{{date}}</div>        <select data-type="hour">{{hours}}</select>        :        <select data-type="min">{{mins}}</select>      </div>    ',"list.Modal":'      <div class="bbf-list-modal">        {{summary}}      </div>    '},{error:"bbf-error"});Form.VERSION="0.11.0";Backbone.Form=Form})(this);(function($,_,Backbone){var _interpolateBackup=_.templateSettings;_.templateSettings={interpolate:/\{\{(.+?)\}\}/g,evaluate:/<%([\s\S]+?)%>/g};var template=_.template('    <% if (title) { %>      <div class="modal-header">        <% if (allowCancel) { %>          <a class="close">×</a>        <% } %>        <h3>{{title}}</h3>      </div>    <% } %>    <div class="modal-body">{{content}}</div>    <div class="modal-footer">      <% if (allowCancel) { %>        <% if (cancelText) { %>          <a href="#" class="btn cancel">{{cancelText}}</a>        <% } %>      <% } %>      <a href="#" class="btn ok btn-primary">{{okText}}</a>    </div>  ');_.templateSettings=_interpolateBackup;var Modal=Backbone.View.extend({className:"modal",events:{"click .close":function(event){event.preventDefault();this.trigger("cancel");if(this.options.content&&this.options.content.trigger){this.options.content.trigger("cancel",this)}},"click .cancel":function(event){event.preventDefault();this.trigger("cancel");if(this.options.content&&this.options.content.trigger){this.options.content.trigger("cancel",this)}},"click .ok":function(event){event.preventDefault();this.trigger("ok");if(this.options.content&&this.options.content.trigger){this.options.content.trigger("ok",this)}if(this.options.okCloses){this.close()}}},initialize:function(options){this.options=_.extend({title:null,okText:"OK",focusOk:true,okCloses:true,cancelText:"Cancel",allowCancel:true,escape:true,animate:false,template:template},options)},render:function(){var $el=this.$el,options=this.options,content=options.content;$el.html(options.template(options));var $content=this.$content=$el.find(".modal-body");if(content.$el){content.render();$el.find(".modal-body").html(content.$el)}if(options.animate)$el.addClass("fade");this.isRendered=true;
return this},open:function(cb){if(!this.isRendered)this.render();var self=this,$el=this.$el;$el.modal(_.extend({keyboard:this.options.allowCancel,backdrop:this.options.allowCancel?true:"static"},this.options.modalOptions));$el.one("shown",function(){if(self.options.focusOk){$el.find(".btn.ok").focus()}if(self.options.content&&self.options.content.trigger){self.options.content.trigger("shown",self)}self.trigger("shown")});var numModals=Modal.count,$backdrop=$(".modal-backdrop:eq("+numModals+")"),backdropIndex=parseInt($backdrop.css("z-index"),10),elIndex=parseInt($backdrop.css("z-index"),10);$backdrop.css("z-index",backdropIndex+numModals);this.$el.css("z-index",elIndex+numModals);if(this.options.allowCancel){$backdrop.one("click",function(){if(self.options.content&&self.options.content.trigger){self.options.content.trigger("cancel",self)}self.trigger("cancel")});$(document).one("keyup.dismiss.modal",function(e){e.which==27&&self.trigger("cancel");if(self.options.content&&self.options.content.trigger){e.which==27&&self.options.content.trigger("shown",self)}})}this.on("cancel",function(){self.close()});Modal.count++;if(cb){self.on("ok",cb)}return this},close:function(){var self=this,$el=this.$el;if(this._preventClose){this._preventClose=false;return}$el.one("hidden",function onHidden(e){if(e.target!==e.currentTarget){return $el.one("hidden",onHidden)}self.remove();if(self.options.content&&self.options.content.trigger){self.options.content.trigger("hidden",self)}self.trigger("hidden")});$el.modal("hide");Modal.count--},preventClose:function(){this._preventClose=true}},{count:0});if(typeof require=="function"&&typeof module!=="undefined"&&exports){module.exports=Modal}if(typeof define==="function"&&define.amd){return define(function(){Backbone.BootstrapModal=Modal})}else{Backbone.BootstrapModal=Modal}})(jQuery,_,Backbone);(function(){var Form=Backbone.Form;Form.setTemplates({form:'      <form class="form-horizontal">{{fieldsets}}</form>    ',fieldset:"      <fieldset>        <legend>{{legend}}</legend>        {{fields}}      </fieldset>    ",field:'      <div class="control-group field-{{key}}">        <label class="control-label" for="{{id}}">{{title}}</label>        <div class="controls">          {{editor}}          <div class="help-inline">{{error}}</div>          <div class="help-block">{{help}}</div>        </div>      </div>    ',nestedField:'      <div class="field-{{key}}">        <div title="{{title}}" class="input-xlarge">{{editor}}          <div class="help-inline">{{error}}</div>        </div>        <div class="help-block">{{help}}</div>      </div>    ',list:'      <div class="bbf-list">        <ul class="unstyled clearfix">{{items}}</ul>        <button class="btn bbf-add" data-action="add">Add</button>      </div>    ',listItem:'      <li class="clearfix">        <div class="pull-left">{{editor}}</div>        <button type="button" class="btn bbf-del" data-action="remove">&times;</button>      </li>    ',date:'      <div class="bbf-date">        <select data-type="date" class="bbf-date">{{dates}}</select>        <select data-type="month" class="bbf-month">{{months}}</select>        <select data-type="year" class="bbf-year">{{years}}</select>      </div>    ',dateTime:'      <div class="bbf-datetime">        <p>{{date}}</p>        <p>          <select data-type="hour" style="width: 4em">{{hours}}</select>          :          <select data-type="min" style="width: 4em">{{mins}}</select>        </p>      </div>    ',"list.Modal":'      <div class="bbf-list-modal">        {{summary}}      </div>    '},{error:"error"})})();(function(){var Form=Backbone.Form,editors=Form.editors;editors.List=editors.Base.extend({events:{'click [data-action="add"]':function(event){event.preventDefault();this.addItem(null,true)}},initialize:function(options){editors.Base.prototype.initialize.call(this,options);var schema=this.schema;if(!schema)throw"Missing required option 'schema'";this.schema=_.extend({listTemplate:"list",listItemTemplate:"listItem"},schema);this.Editor=function(){var type=schema.itemType;if(!type)return editors.Text;if(editors.List[type])return editors.List[type];return editors[type]}();this.items=[]},render:function(){var self=this,value=this.value||[];var $el=Form.helpers.parseHTML(Form.templates[this.schema.listTemplate]({items:'<b class="bbf-tmp"></b>'}));this.$list=$el.find(".bbf-tmp").parent().empty();if(value.length){_.each(value,function(itemValue){self.addItem(itemValue)})}else{if(!this.Editor.isAsync)this.addItem()}this.setElement($el);this.$el.attr("id",this.id);this.$el.attr("name",this.key);if(this.hasFocus)this.trigger("blur",this);return this},addItem:function(value,userInitiated){var self=this;var item=new editors.List.Item({list:this,schema:this.schema,value:value,Editor:this.Editor,key:this.key}).render();var _addItem=function(){self.items.push(item);self.$list.append(item.el);item.editor.on("all",function(event){if(event==="change")return;var args=_.toArray(arguments);args[0]="item:"+event;args.splice(1,0,self);editors.List.prototype.trigger.apply(this,args)},self);item.editor.on("change",function(){if(!item.addEventTriggered){item.addEventTriggered=true;this.trigger("add",this,item.editor)}this.trigger("item:change",this,item.editor);this.trigger("change",this)},self);item.editor.on("focus",function(){if(this.hasFocus)return;this.trigger("focus",this)},self);item.editor.on("blur",function(){if(!this.hasFocus)return;var self=this;setTimeout(function(){if(_.find(self.items,function(item){return item.editor.hasFocus}))return;self.trigger("blur",self)},0)},self);if(userInitiated||value){item.addEventTriggered=true}if(userInitiated){self.trigger("add",self,item.editor);self.trigger("change",self)}};if(this.Editor.isAsync){item.editor.on("readyToAdd",_addItem,this)}else{_addItem();item.editor.focus()}return item},removeItem:function(item){var confirmMsg=this.schema.confirmDelete;if(confirmMsg&&!confirm(confirmMsg))return;var index=_.indexOf(this.items,item);this.items[index].remove();this.items.splice(index,1);if(item.addEventTriggered){this.trigger("remove",this,item.editor);this.trigger("change",this)}if(!this.items.length&&!this.Editor.isAsync)this.addItem()},getValue:function(){var values=_.map(this.items,function(item){return item.getValue()});return _.without(values,undefined,"")},setValue:function(value){this.value=value;this.render()},focus:function(){if(this.hasFocus)return;if(this.items[0])this.items[0].editor.focus()},blur:function(){if(!this.hasFocus)return;var focusedItem=_.find(this.items,function(item){return item.editor.hasFocus});if(focusedItem)focusedItem.editor.blur()},remove:function(){_.invoke(this.items,"remove");editors.Base.prototype.remove.call(this)},validate:function(){if(!this.validators)return null;var errors=_.map(this.items,function(item){return item.validate()});var hasErrors=_.compact(errors).length?true:false;if(!hasErrors)return null;var fieldError={type:"list",message:"Some of the items in the list failed validation",errors:errors};return fieldError}});editors.List.Item=Backbone.View.extend({events:{'click [data-action="remove"]':function(event){event.preventDefault();this.list.removeItem(this)},"keydown input[type=text]":function(event){if(event.keyCode!==13)return;event.preventDefault();this.list.addItem();this.list.$list.find("> li:last input").focus()}},initialize:function(options){this.list=options.list;this.schema=options.schema||this.list.schema;this.value=options.value;this.Editor=options.Editor||editors.Text;this.key=options.key},render:function(){this.editor=new this.Editor({key:this.key,schema:this.schema,value:this.value,list:this.list,item:this}).render();var $el=Form.helpers.parseHTML(Form.templates[this.schema.listItemTemplate]({editor:'<b class="bbf-tmp"></b>'}));$el.find(".bbf-tmp").replaceWith(this.editor.el);this.setElement($el);return this},getValue:function(){return this.editor.getValue()},setValue:function(value){this.editor.setValue(value)},focus:function(){this.editor.focus()},blur:function(){this.editor.blur()},remove:function(){this.editor.remove();Backbone.View.prototype.remove.call(this)},validate:function(){var value=this.getValue(),formValues=this.list.form?this.list.form.getValue():{},validators=this.schema.validators,getValidator=Form.helpers.getValidator;if(!validators)return null;var error=null;_.every(validators,function(validator){error=getValidator(validator)(value,formValues);return error?false:true});if(error){this.setError(error)}else{this.clearError()}return error?error:null},setError:function(err){this.$el.addClass(Form.classNames.error);this.$el.attr("title",err.message)},clearError:function(){this.$el.removeClass(Form.classNames.error);this.$el.attr("title",null)}});editors.List.Modal=editors.Base.extend({events:{click:"openEditor"},initialize:function(options){editors.Base.prototype.initialize.call(this,options);if(!editors.List.Modal.ModalAdapter)throw"A ModalAdapter is required"},render:function(){var self=this;if(_.isEmpty(this.value)){this.openEditor()}else{this.renderSummary();setTimeout(function(){self.trigger("readyToAdd")},0)}if(this.hasFocus)this.trigger("blur",this);return this},renderSummary:function(){var template=Form.templates["list.Modal"];this.$el.html(template({summary:this.getStringValue()}))},itemToString:function(value){value=value||{};var parts=[];_.each(this.nestedSchema,function(schema,key){var desc=schema.title?schema.title:Form.helpers.keyToTitle(key),val=value[key];if(_.isUndefined(val)||_.isNull(val))val="";parts.push(desc+": "+val)});return parts.join("<br />")},getStringValue:function(){var schema=this.schema,value=this.getValue();if(_.isEmpty(value))return"[Empty]";if(schema.itemToString)return schema.itemToString(value);return this.itemToString(value)},openEditor:function(){var self=this;var form=this.modalForm=new Form({schema:this.nestedSchema,data:this.value});var modal=this.modal=new editors.List.Modal.ModalAdapter({content:form,animate:true});modal.open();this.trigger("open",this);this.trigger("focus",this);modal.on("cancel",this.onModalClosed,this);modal.on("ok",_.bind(this.onModalSubmitted,this))},onModalSubmitted:function(){var modal=this.modal,form=this.modalForm,isNew=!this.value;var error=form.validate();if(error)return modal.preventClose();this.value=form.getValue();this.renderSummary();if(isNew)this.trigger("readyToAdd");this.trigger("change",this);this.onModalClosed()},onModalClosed:function(){this.modal=null;this.modalForm=null;this.trigger("close",this);this.trigger("blur",this)},getValue:function(){return this.value},setValue:function(value){this.value=value},focus:function(){if(this.hasFocus)return;this.openEditor()},blur:function(){if(!this.hasFocus)return;if(this.modal){this.modal.trigger("cancel")}}},{ModalAdapter:Backbone.BootstrapModal,isAsync:true});editors.List.Object=editors.List.Modal.extend({initialize:function(){editors.List.Modal.prototype.initialize.apply(this,arguments);var schema=this.schema;if(!schema.subSchema)throw'Missing required option "schema.subSchema"';this.nestedSchema=schema.subSchema}});editors.List.NestedModel=editors.List.Modal.extend({initialize:function(){editors.List.Modal.prototype.initialize.apply(this,arguments);var schema=this.schema;if(!schema.model)throw'Missing required option "schema.model"';var nestedSchema=schema.model.prototype.schema;this.nestedSchema=_.isFunction(nestedSchema)?nestedSchema():nestedSchema},getStringValue:function(){var schema=this.schema,value=this.getValue();if(_.isEmpty(value))return null;if(schema.itemToString)return schema.itemToString(value);return new schema.model(value).toString()}})})();function StringBuffer(){this.buffer=[]}StringBuffer.prototype.append=function append(string){this.buffer.push(string);return this};StringBuffer.prototype.toString=function toString(){return this.buffer.join("")};var Base64={codex:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(input){var output=new StringBuffer;var enumerator=new Utf8EncodeEnumerator(input);while(enumerator.moveNext()){var chr1=enumerator.current;enumerator.moveNext();var chr2=enumerator.current;enumerator.moveNext();var chr3=enumerator.current;var enc1=chr1>>2;var enc2=(chr1&3)<<4|chr2>>4;var enc3=(chr2&15)<<2|chr3>>6;var enc4=chr3&63;if(isNaN(chr2)){enc3=enc4=64}else if(isNaN(chr3)){enc4=64}output.append(this.codex.charAt(enc1)+this.codex.charAt(enc2)+this.codex.charAt(enc3)+this.codex.charAt(enc4))}return output.toString()},decode:function(input){var output=new StringBuffer;var enumerator=new Base64DecodeEnumerator(input);while(enumerator.moveNext()){var charCode=enumerator.current;if(charCode<128)output.append(String.fromCharCode(charCode));else if(charCode>191&&charCode<224){enumerator.moveNext();var charCode2=enumerator.current;output.append(String.fromCharCode((charCode&31)<<6|charCode2&63))}else{enumerator.moveNext();var charCode2=enumerator.current;enumerator.moveNext();var charCode3=enumerator.current;output.append(String.fromCharCode((charCode&15)<<12|(charCode2&63)<<6|charCode3&63))}}return output.toString()}};function Utf8EncodeEnumerator(input){this._input=input;this._index=-1;this._buffer=[]}Utf8EncodeEnumerator.prototype={current:Number.NaN,moveNext:function(){if(this._buffer.length>0){this.current=this._buffer.shift();return true}else if(this._index>=this._input.length-1){this.current=Number.NaN;return false}else{var charCode=this._input.charCodeAt(++this._index);if(charCode==13&&this._input.charCodeAt(this._index+1)==10){charCode=10;this._index+=2}if(charCode<128){this.current=charCode}else if(charCode>127&&charCode<2048){this.current=charCode>>6|192;this._buffer.push(charCode&63|128)}else{this.current=charCode>>12|224;this._buffer.push(charCode>>6&63|128);this._buffer.push(charCode&63|128)}return true}}};function Base64DecodeEnumerator(input){this._input=input;this._index=-1;this._buffer=[]}Base64DecodeEnumerator.prototype={current:64,moveNext:function(){if(this._buffer.length>0){this.current=this._buffer.shift();return true}else if(this._index>=this._input.length-1){this.current=64;return false}else{var enc1=Base64.codex.indexOf(this._input.charAt(++this._index));var enc2=Base64.codex.indexOf(this._input.charAt(++this._index));var enc3=Base64.codex.indexOf(this._input.charAt(++this._index));var enc4=Base64.codex.indexOf(this._input.charAt(++this._index));var chr1=enc1<<2|enc2>>4;var chr2=(enc2&15)<<4|enc3>>2;var chr3=(enc3&3)<<6|enc4;this.current=chr1;if(enc3!=64)this._buffer.push(chr2);if(enc4!=64)this._buffer.push(chr3);return true}}};var bootbox=window.bootbox||function(w,n){function k(b,a){"undefined"===typeof a&&(a=p);return"string"===typeof j[a][b]?j[a][b]:a!=t?k(b,t):b}var p="en",t="en",u=!0,s="static",v="",l={},g={},m={setLocale:function(b){for(var a in j)if(a==b){p=b;return}throw Error("Invalid locale: "+b)},addLocale:function(b,a){"undefined"===typeof j[b]&&(j[b]={});for(var c in a)j[b][c]=a[c]},setIcons:function(b){g=b;if("object"!==typeof g||null===g)g={}},setBtnClasses:function(b){l=b;if("object"!==typeof l||null===l)l={}},alert:function(){var b="",a=k("OK"),c=null;switch(arguments.length){case 1:b=arguments[0];break;case 2:b=arguments[0];"function"==typeof arguments[1]?c=arguments[1]:a=arguments[1];break;case 3:b=arguments[0];a=arguments[1];c=arguments[2];break;default:throw Error("Incorrect number of arguments: expected 1-3")}return m.dialog(b,{label:a,icon:g.OK,"class":l.OK,callback:c},{onEscape:c||!0})},confirm:function(){var b="",a=k("CANCEL"),c=k("CONFIRM"),e=null;switch(arguments.length){case 1:b=arguments[0];break;case 2:b=arguments[0];"function"==typeof arguments[1]?e=arguments[1]:a=arguments[1];break;case 3:b=arguments[0];a=arguments[1];"function"==typeof arguments[2]?e=arguments[2]:c=arguments[2];break;case 4:b=arguments[0];a=arguments[1];c=arguments[2];e=arguments[3];break;default:throw Error("Incorrect number of arguments: expected 1-4")}var h=function(){if("function"===typeof e)return e(!1)};return m.dialog(b,[{label:a,icon:g.CANCEL,"class":l.CANCEL,callback:h},{label:c,icon:g.CONFIRM,"class":l.CONFIRM,callback:function(){if("function"===typeof e)return e(!0)}}],{onEscape:h})},prompt:function(){var b="",a=k("CANCEL"),c=k("CONFIRM"),e=null,h="";switch(arguments.length){case 1:b=arguments[0];break;case 2:b=arguments[0];"function"==typeof arguments[1]?e=arguments[1]:a=arguments[1];break;case 3:b=arguments[0];a=arguments[1];"function"==typeof arguments[2]?e=arguments[2]:c=arguments[2];break;case 4:b=arguments[0];a=arguments[1];c=arguments[2];e=arguments[3];break;case 5:b=arguments[0];a=arguments[1];c=arguments[2];e=arguments[3];h=arguments[4];break;default:throw Error("Incorrect number of arguments: expected 1-5")}var q=n("<form></form>");q.append("<input autocomplete=off type=text value='"+h+"' />");var h=function(){if("function"===typeof e)return e(null)},d=m.dialog(q,[{label:a,icon:g.CANCEL,"class":l.CANCEL,callback:h},{label:c,icon:g.CONFIRM,"class":l.CONFIRM,callback:function(){if("function"===typeof e)return e(q.find("input[type=text]").val())}}],{header:b,show:!1,onEscape:h});d.on("shown",function(){q.find("input[type=text]").focus();q.on("submit",function(a){a.preventDefault();d.find(".btn-primary").click()})});d.modal("show");return d},dialog:function(b,a,c){function e(){var a=null;"function"===typeof c.onEscape&&(a=c.onEscape());!1!==a&&f.modal("hide")}var h="",l=[];c||(c={});"undefined"===typeof a?a=[]:"undefined"==typeof a.length&&(a=[a]);for(var d=a.length;d--;){var g=null,k=null,j=null,m="",p=null;if("undefined"==typeof a[d].label&&"undefined"==typeof a[d]["class"]&&"undefined"==typeof a[d].callback){var g=0,k=null,r;for(r in a[d])if(k=r,1<++g)break;1==g&&"function"==typeof a[d][r]&&(a[d].label=k,a[d].callback=a[d][r])}"function"==typeof a[d].callback&&(p=a[d].callback);a[d]["class"]?j=a[d]["class"]:d==a.length-1&&2>=a.length&&(j="btn-primary");g=a[d].label?a[d].label:"Option "+(d+1);a[d].icon&&(m="<i class='"+a[d].icon+"'></i> ");k=a[d].href?a[d].href:"javascript:;";h="<a data-handler='"+d+"' class='btn "+j+"' href='"+k+"'>"+m+""+g+"</a>"+h;l[d]=p}d=["<div class='bootbox modal' tabindex='-1' style='overflow:hidden;'>"];if(c.header){j="";if("undefined"==typeof c.headerCloseButton||c.headerCloseButton)j="<a href='javascript:;' class='close'>&times;</a>";d.push("<div class='modal-header'>"+j+"<h3>"+c.header+"</h3></div>")}d.push("<div class='modal-body'></div>");h&&d.push("<div class='modal-footer'>"+h+"</div>");d.push("</div>");var f=n(d.join("\n"));("undefined"===typeof c.animate?u:c.animate)&&f.addClass("fade");(h="undefined"===typeof c.classes?v:c.classes)&&f.addClass(h);f.find(".modal-body").html(b);f.on("keyup.dismiss.modal",function(a){27===a.which&&c.onEscape&&e("escape")});f.on("click","a.close",function(a){a.preventDefault();e("close")});f.on("shown",function(){f.find("a.btn-primary:first").focus()});f.on("hidden",function(){f.remove()});f.on("click",".modal-footer a",function(b){var c=n(this).data("handler"),d=l[c],e=null;"undefined"!==typeof c&&"undefined"!==typeof a[c].href||(b.preventDefault(),"function"===typeof d&&(e=d()),!1!==e&&f.modal("hide"))});n("body").append(f);f.modal({backdrop:"undefined"===typeof c.backdrop?s:c.backdrop,keyboard:!1,show:!1});f.on("show",function(){n(w).off("focusin.modal")});("undefined"===typeof c.show||!0===c.show)&&f.modal("show");return f},modal:function(){var b,a,c,e={onEscape:null,keyboard:!0,backdrop:s};switch(arguments.length){case 1:b=arguments[0];break;case 2:b=arguments[0];"object"==typeof arguments[1]?c=arguments[1]:a=arguments[1];break;case 3:b=arguments[0];a=arguments[1];c=arguments[2];break;default:throw Error("Incorrect number of arguments: expected 1-3")}e.header=a;c="object"==typeof c?n.extend(e,c):e;return m.dialog(b,[],c)},hideAll:function(){n(".bootbox").modal("hide")},animate:function(b){u=b},backdrop:function(b){s=b},classes:function(b){v=b}},j={en:{OK:"OK",CANCEL:"Cancel",CONFIRM:"OK"},fr:{OK:"OK",CANCEL:"Annuler",CONFIRM:"D'accord"},de:{OK:"OK",CANCEL:"Abbrechen",CONFIRM:"Akzeptieren"},es:{OK:"OK",CANCEL:"Cancelar",CONFIRM:"Aceptar"},br:{OK:"OK",CANCEL:"Cancelar",CONFIRM:"Sim"},nl:{OK:"OK",CANCEL:"Annuleren",CONFIRM:"Accepteren"},ru:{OK:"OK",CANCEL:"Отмена",CONFIRM:"Применить"},it:{OK:"OK",CANCEL:"Annulla",CONFIRM:"Conferma"}};return m}(document,window.jQuery);window.bootbox=bootbox;(function($){var methods={preload:function(callback){this._preloadCount=0;return this.each($.proxy(function(index,element){this.templatePath=$(element).attr("href");this.templateName=$(element).attr("id")||this.attr("data-templateName");if(!$(this).data("template")){$.ajax({type:"GET",url:this.templatePath,context:this,success:function(response,status,request){this._preloadCount++;$(element).data("template",response);if(callback&&this._preloadCount==this.length&&$.isFunction(callback))callback.call(this)}})}else if(callback&&index==this.length-1&&$.isFunction(callback))callback.call(this)},this))},render:function(data,callback){if(typeof callback=="undefined")throw new Error("Missing the callback attribute in Chevron render method");return this.each(function(){this.renderData=data;this.callback=callback;this.templatePath=$(this).attr("href");this.templateName=$(this).attr("id")||$(this).attr("data-templateName");if(!$(this).data("template")){$.ajax({type:"GET",url:this.templatePath,success:$.proxy(methods.invokeRender,this)})}else methods.invokeRender.call(this,$(this).data("template"))})},renderTemplate:function(templateText,templateData){return Mustache.to_html(templateText,templateData)},invokeRender:function(response){if(!$(this).data("template"))$(this).data("template",response);var result=methods.renderTemplate(response,this.renderData);if($.isFunction(this.callback)){this.callback.call(this,result)}else if(this.callback instanceof jQuery){this.callback.html(result)}else if(typeof this.callback=="string")$(this.callback).html(result);else throw new Error("Chevron render method received an unsuported callback type")}};$.Chevron=$.fn.Chevron=function(method){var self=this;if(!self.selector)self=$("link[rel=template]");if(methods[method])return methods[method].apply(self,Array.prototype.slice.call(arguments,1));else if(!method)throw new Error("Chevron must receive a method to call as first argument");else throw new Error("Method "+method+" does not exist on Chevron")}})(jQuery);$(function(){Backbone.Form.editors.List.Modal.ModalAdapter=Backbone.BootstrapModal;Backbone.Form.helpers.keyToTitle=function(key){return key};var ModelsClasses=[General,System,Integrator,Simulation];var collection=new Collection([]);for(var i in ModelsClasses){model=new ModelsClasses[i];var form=new Backbone.Form({idPrefix:key+"-",model:model}).render();form.on("change",function(form,editor){form.commit({validate:true})});$(model.el).append(form.el);collection.add(model);for(var key in model.schema){var options=model.schema[key];var label=$('label[for="'+form.options.idPrefix+key+'"]');var name=label[0].innerHTML;$(label).html("");label.append('<a class="sidebar-label" href="#">'+name+"</a>");if("help"in options){label.popover({content:options.help})}}$(form.el).find(".help-block").remove()}var myview=new OpenMMScriptView({collection:collection})});$(function(){$("#sidebar-tab a").click(function(e){e.preventDefault();$(this).tab("show")})});$(function(){$("#save-script-local").click(function(){var form=$("#save-form");var script_input=$("<input name='value'></input");var filename_input=form.find('input[name="filename"]');var set_value_from_placeholder=false;if(filename_input[0].value==""){set_value_from_placeholder=true;filename_input[0].value=filename_input.attr("placeholder")}var rawcode=$("<div />").html($("#code").data("rawcode")).text();var b64code=Base64.encode(rawcode);script_input.attr("type","hidden").attr("value",b64code).appendTo(form);form.submit();if(set_value_from_placeholder){filename_input[0].value=""}})});validators={units:{time:[/^\d+(\.\d+)?\s*(fs|ns|ps)$/],friction:[/^\d+(\.\d+)?\s*\/(fs|ps|ns)$/],distance:[/^\d+(\.\d+)?\s*(A|nm)$/],temperature:[/^\d+(\.\d+)?\s*(K)$/]},integer:[/^\d+$/]};Collection=Backbone.Collection.extend({model:Backbone.Model});General=Backbone.Model.extend({el:"#sidepane-general",name:"general",schema:{file:{type:"Text",title:"input file",help:"OpenMM can take a PDB as input!"},protein:{type:"Select",title:"protein forcefield",options:["amber03.xml","amber03_gbvi.xml","amber03_obc.xml","amber10.xml","amber10_gbvi.xml","amber10_obc.xml","amber96.xml","amber96_gbvi.xml","amber96_obc.xml","amber99_gbvi.xml","amber99_obc.xml","amber99sb.xml","amber99sbildn.xml","amber99sbnmr.xml"],help:"Forcefield to use for the protein atoms.                        If you'd like to use implicit solvent, you                        can select that here as well (obc or gbvi)."},water:{type:"Select",options:["spce.xml","tip3p.xml","tip4pew.xml","tip5p.xml"],title:"water forcefield",help:"Forcefield to use for water, for explicit solvent                        calculations. If you're using implicit solvent,                        that needs to be set in the protein forcefield option."},platform:{type:"Select",options:["Reference","OpenCL","CUDA"],help:"GPUs are awesome!"}},defaults:{file:"input.pdb",protein:"amber99sb.xml",water:"tip3p.xml",platform:"CUDA"},jsonify:function(){raw=this.toJSON();raw.explicit_water=true;if(raw.protein.indexOf("obc")!=-1||raw.protein.indexOf("gbvi")!=-1){raw.explicit_water=false}return raw}});var System=Backbone.Model.extend({el:"#sidepane-system",name:"system",schema:{nb_method:{type:"Select",options:["NoCutoff","CutoffNonPeriodic","CutoffPeriodic","Ewald","PME"],title:"nb method",help:"Method for deailing with long range                   non-bondend interactions."},constraints:{type:"Select",options:["None","HBonds","HAngles","AllBonds"],help:"Applying constraints to some of the atoms can enable you                          to take longer timesteps."},rigid_water:{type:"Select",options:["True","False"],title:"rigid water"},nb_cutoff:{type:"Text",title:"nb cutoff",validators:validators.units.distance,help:'Cutoff for long-range non-bonded interactions. This option is                          important for all non-bonded methods except for "nocutoff"'}},defaults:{nb_method:"PME",constraints:"HAngles",rigid_water:"True",nb_cutoff:"1.0 nm"},jsonify:function(){raw=this.toJSON();raw.nb_cutoff=raw.nb_cutoff.replace("nm","* nanometers");raw.nb_cutoff=raw.nb_cutoff.replace("A","* angstroms");raw.has_cutoff=true;if(raw.nb_method=="NoCutoff"){raw.has_cutoff=false}return raw}});var Integrator=Backbone.Model.extend({el:"#sidepane-integrator",name:"integrator",schema:{kind:{type:"Select",options:["Langevin","Brownian","Verlet"],title:"integrator",help:"Which integrator do you prefer?"},timestep:{type:"Text",validators:validators.units.time,help:"Timestep for the integrator!"},friction:{type:"Text",validators:validators.units.friction,help:"Friction coefficient, for use with stochastic integrators."},temperature:{type:"Text",validators:validators.units.temperature,help:"For use with stochastic integrators."}},defaults:{kind:"Langevin",timestep:"2.0 fs",friction:"91.0/ps",temperature:"300 K"},jsonify:function(){raw=this.toJSON();raw.stochastic_active=true;raw.timestep=raw.timestep.replace("fs","* femtoseconds");raw.timestep=raw.timestep.replace("ns","* nanoseconds");raw.timestep=raw.timestep.replace("ps","* picoseconds");raw.friction=raw.friction.replace("ps","picoseconds");raw.temperature=raw.temperature.replace("K","* kelvin");if(raw.kind=="Verlet"){raw.stochastic_active=false}return raw}});var Simulation=Backbone.Model.extend({el:"#sidepane-simulation",name:"simulation",schema:{n_steps:{type:"Text",title:"n steps",validators:validators.integer,help:"Number of steps to take in the simulation"},minimize:{type:"Select",options:["true","false"],help:"Should we run energy minimization first?"},minimize_iters:{type:"Text",title:"max minimize steps",validators:validators.integer,help:"Maximum number of steps for the minimizer."},dcd_reporter:{type:"Select",options:["true","false"],title:"DCD reporter",help:"Attach a DCD Reporter, to save the trajectory"},dcd_freq:{type:"Text",title:"DCD freq [steps]",validators:validators.integer,help:"Freqnency, in steps, with which to save the positions to the DCD file"},dcd_file:{type:"Text",title:"DCD filename",help:"Filename for the DCD trajectory file"},statedata_reporter:{type:"Select",options:["true","false"],title:"StateData reporter",help:"Attach a StateDataReporter to the simulation, to print some                                 statistics to stdout as the simulation is running"},statedata_freq:{type:"Text",title:"StateData freq [steps]",validators:validators.integer,help:"Frequency, in steps, to print                         the StateData statistics to stdout"}},defaults:{n_steps:1e3,minimize:"true",minimize_iters:100,dcd_reporter:"true",dcd_freq:100,dcd_file:"output.dcd",statedata_reporter:"true",statedata_freq:100},jsonify:function(){raw=this.toJSON();raw.dcd_reporter=raw.dcd_reporter=="true";raw.statedata_reporter=raw.statedata_reporter=="true";raw.minimize=raw.minimize=="true";return raw}});var OpenMMScriptView=Backbone.View.extend({initialize:function(){this.collection.bind("change",this.render);this.models=this.collection.models;this.render()},render:function(){el="#code";values={};for(var i=0;i<this.models.length;i++){var name=this.models[i].name;values[name]=this.models[i].jsonify()}$("#template-mustache").Chevron("render",values,function(result){$(el).data("rawcode",result);$(el).html(prettyPrintOne(result))})}});